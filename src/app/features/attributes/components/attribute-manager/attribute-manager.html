<!-- src/app/features/attributes/components/attribute-manager/attribute-manager.html -->
<div class="attribute-manager">
  @if (showTitle()) {
    <div class="manager-header">
      <h3 class="mat-headline-small">
        <mat-icon>tune</mat-icon>
        Property Attributes
      </h3>
      <p class="mat-body-medium">
        @if (readonly()) {
          View property attribute values
        } @else {
          Manage and configure property attribute values
        }
      </p>
    </div>
    <mat-divider></mat-divider>
  }

  <div class="manager-content">
    @if (attributesLoading()) {
      <div class="loading-container">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p class="mat-body-medium">Loading attributes...</p>
      </div>
    } @else if (attributes().length === 0) {
      <mat-card class="empty-state-card">
        <mat-card-content class="empty-content">
          <mat-icon class="empty-icon">info</mat-icon>
          <h3 class="mat-headline-small">No Attributes Available</h3>
          <p class="mat-body-medium">No property attributes have been configured yet.</p>
        </mat-card-content>
      </mat-card>
    } @else {
      <!-- Categorized Attributes -->
      <mat-accordion multi="true" class="attributes-accordion">
        @for (categoryEntry of categorizedAttributes() | keyvalue; track trackByCategory($index, categoryEntry)) {
          <mat-expansion-panel
            [expanded]="categoryEntry.key === 'BASICS'"
            class="category-panel">

            <!-- Panel Header -->
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon class="category-icon">{{ getCategoryIcon(categoryEntry.key) }}</mat-icon>
                {{ getCategoryDisplayName(categoryEntry.key) }}
              </mat-panel-title>
              <mat-panel-description>
                {{ categoryEntry.value.length }}
                {{ categoryEntry.value.length === 1 ? 'attribute' : 'attributes' }}
                @if (!readonly() && hasUnsavedChangesInCategory(categoryEntry.key)) {
                  <mat-icon class="unsaved-icon" matTooltip="Has unsaved changes" color="warn">
                    circle
                  </mat-icon>
                }
              </mat-panel-description>
            </mat-expansion-panel-header>

            <!-- Panel Content -->
            <div class="category-content">
              @for (attribute of categoryEntry.value; track trackByAttribute($index, attribute)) {
                <div class="attribute-container">
                  <div class="attribute-field">
                    <app-attribute-form-field
                      [attribute]="attribute"
                      [value]="getAttributeValue(attribute.id)"
                      [disabled]="readonly() || isAttributeSaving(attribute.id)"
                      (valueChange)="onAttributeValueChange($event)">
                    </app-attribute-form-field>
                  </div>

                  @if (!readonly()) {
                    <div class="attribute-actions">
                      <!-- Save Button -->
                      <button
                        mat-icon-button
                        color="primary"
                        [disabled]="isAttributeSaving(attribute.id) || !hasValueToSave(attribute.id)"
                        [matTooltip]="hasValueToSave(attribute.id) ? 'Save attribute value' : 'No value to save'"
                        (click)="saveAttributeValue(attribute.id)">
                        @if (isAttributeSaving(attribute.id)) {
                          <mat-progress-spinner diameter="20"></mat-progress-spinner>
                        } @else {
                          <mat-icon>save</mat-icon>
                        }
                      </button>

                      <!-- Delete Button -->
                      @if (hasExistingValue(attribute.id)) {
                        <button
                          mat-icon-button
                          color="warn"
                          [disabled]="isAttributeDeleting(attribute.id)"
                          matTooltip="Delete attribute value"
                          (click)="deleteAttributeValue(attribute.id)">
                          @if (isAttributeDeleting(attribute.id)) {
                            <mat-progress-spinner diameter="20"></mat-progress-spinner>
                          } @else {
                            <mat-icon>delete</mat-icon>
                          }
                        </button>
                      }
                    </div>
                  }
                </div>

                @if ($index < categoryEntry.value.length - 1) {
                  <mat-divider class="attribute-divider"></mat-divider>
                }
              }
            </div>
          </mat-expansion-panel>
        }
      </mat-accordion>

      <!-- Action Buttons -->
      @if (!readonly()) {
        <div class="manager-actions">
          <mat-divider></mat-divider>

          <div class="action-buttons">
            <button
              mat-button
              color="accent"
              [disabled]="!hasUnsavedChanges()"
              (click)="saveAllAttributes()">
              <mat-icon>save_alt</mat-icon>
              Save All Changes
            </button>

            <button
              mat-stroked-button
              color="primary"
              (click)="refreshAttributes()">
              <mat-icon>refresh</mat-icon>
              Refresh
            </button>
          </div>

          @if (hasUnsavedChanges()) {
            <mat-card class="warning-card">
              <mat-card-content class="warning-content">
                <mat-icon color="warn">warning</mat-icon>
                <span class="mat-body-medium">You have unsaved changes. Don't forget to save your modifications.</span>
              </mat-card-content>
            </mat-card>
          }
        </div>
      }
    }
  </div>
</div>
