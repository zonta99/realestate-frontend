<!-- src/app/features/properties/components/property-form/property-form.html -->
<div class="mat-app-background">
  <!-- Header using Material Toolbar -->
  <mat-toolbar color="primary" class="mat-elevation-2">
    <button
      mat-icon-button
      (click)="goBack()"
      [disabled]="saving()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="mat-headline-medium">{{ pageTitle() }}</span>
    <span class="spacer"></span>
  </mat-toolbar>

  <!-- Content Container -->
  <div class="content-container">
    <!-- Loading State -->
    @if (loading()) {
      <mat-card appearance="outlined" class="loading-card mat-elevation-2">
        <mat-card-content class="loading-content">
          <mat-progress-spinner diameter="50"></mat-progress-spinner>
          <p class="mat-body-large">Loading form data...</p>
        </mat-card-content>
      </mat-card>
    } @else {
      <div class="form-layout">
        <!-- Main Form Card -->
        <mat-card appearance="outlined" class="form-card mat-elevation-2">
          <mat-card-header>
            <div mat-card-avatar>
              <mat-icon>{{ isEditMode() ? 'edit' : 'home' }}</mat-icon>
            </div>
            <mat-card-title class="mat-headline-small">Property Details</mat-card-title>
            <mat-card-subtitle class="mat-body-medium">
              {{ isEditMode() ? 'Update the property information' : 'Fill in the information to create a new property' }}
            </mat-card-subtitle>
          </mat-card-header>

          <form [formGroup]="propertyForm" (ngSubmit)="onSubmit()">
            <mat-card-content>
              @if (saving()) {
                <mat-progress-bar mode="indeterminate" class="form-progress"></mat-progress-bar>
              }

              <div class="form-fields">
                <!-- Title Field -->
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Property Title</mat-label>
                  <input
                    matInput
                    formControlName="title"
                    placeholder="Enter property title"
                    [disabled]="saving()">
                  <mat-icon matSuffix>title</mat-icon>
                  @if (propertyForm.get('title')?.invalid && propertyForm.get('title')?.touched) {
                    <mat-error>
                      @if (propertyForm.get('title')?.hasError('required')) {
                        Title is required
                      }
                      @if (propertyForm.get('title')?.hasError('minlength')) {
                        Title must be at least 3 characters long
                      }
                      @if (propertyForm.get('title')?.hasError('maxlength')) {
                        Title cannot exceed 200 characters
                      }
                    </mat-error>
                  }
                </mat-form-field>

                <!-- Description Field -->
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Description</mat-label>
                  <textarea
                    matInput
                    formControlName="description"
                    placeholder="Enter property description"
                    rows="4"
                    [disabled]="saving()">
                  </textarea>
                  <mat-icon matSuffix>description</mat-icon>
                  @if (propertyForm.get('description')?.invalid && propertyForm.get('description')?.touched) {
                    <mat-error>
                      @if (propertyForm.get('description')?.hasError('required')) {
                        Description is required
                      }
                      @if (propertyForm.get('description')?.hasError('minlength')) {
                        Description must be at least 10 characters long
                      }
                      @if (propertyForm.get('description')?.hasError('maxlength')) {
                        Description cannot exceed 1000 characters
                      }
                    </mat-error>
                  }
                </mat-form-field>

                <!-- Price Field -->
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Price</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="price"
                    placeholder="0"
                    [disabled]="saving()">
                  <span matTextPrefix>$&nbsp;</span>
                  <mat-icon matSuffix>attach_money</mat-icon>
                  @if (propertyForm.get('price')?.invalid && propertyForm.get('price')?.touched) {
                    <mat-error>
                      @if (propertyForm.get('price')?.hasError('required')) {
                        Price is required
                      }
                      @if (propertyForm.get('price')?.hasError('min')) {
                        Price must be greater than 0
                      }
                      @if (propertyForm.get('price')?.hasError('max')) {
                        Price cannot exceed $50,000,000
                      }
                    </mat-error>
                  }
                </mat-form-field>

                <!-- Status Field (Edit Mode Only) -->
                @if (isEditMode()) {
                  <mat-form-field appearance="outline" subscriptSizing="dynamic">
                    <mat-label>Status</mat-label>
                    <mat-select formControlName="status" [disabled]="saving()">
                      <mat-option value="ACTIVE">Active</mat-option>
                      <mat-option value="PENDING">Pending</mat-option>
                      <mat-option value="SOLD">Sold</mat-option>
                      <mat-option value="INACTIVE">Inactive</mat-option>
                    </mat-select>
                    <mat-icon matSuffix>flag</mat-icon>
                    @if (propertyForm.get('status')?.invalid && propertyForm.get('status')?.touched) {
                      <mat-error>
                        Status is required
                      </mat-error>
                    }
                  </mat-form-field>
                }
              </div>

              <!-- Dynamic Attributes Section -->
              @if (attributes().length > 0) {
                <div class="attributes-section">
                  <mat-divider></mat-divider>

                  <div class="section-header">
                    <h3 class="mat-headline-small">Property Attributes</h3>
                    <p class="mat-body-medium">Additional property information</p>
                  </div>

                  <!-- Categorized Attributes -->
                  <mat-accordion multi="true" class="attributes-accordion">
                    @for (categoryEntry of categorizedAttributes() | keyvalue; track trackByCategory($index, categoryEntry)) {
                      <mat-expansion-panel
                        [expanded]="categoryEntry.key === 'BASICS'"
                        class="category-panel">

                        <!-- Panel Header -->
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            <mat-icon class="category-icon">{{ getCategoryIcon(categoryEntry.key) }}</mat-icon>
                            {{ getCategoryDisplayName(categoryEntry.key) }}
                          </mat-panel-title>
                          <mat-panel-description>
                            {{ categoryEntry.value.length }}
                            {{ categoryEntry.value.length === 1 ? 'attribute' : 'attributes' }}
                          </mat-panel-description>
                        </mat-expansion-panel-header>

                        <!-- Panel Content -->
                        <div class="category-attributes">
                          @for (attribute of categoryEntry.value; track trackByAttribute($index, attribute)) {
                            <app-attribute-form-field
                              [attribute]="attribute"
                              [value]="getAttributeValue(attribute.id)"
                              [disabled]="saving()"
                              [isDirty]="changeTrackingService.isAttributeDirty(attribute.id)"
                              (valueChange)="onAttributeValueChange($event)">
                            </app-attribute-form-field>
                          }
                        </div>
                      </mat-expansion-panel>
                    }
                  </mat-accordion>
                </div>
              }

              <!-- Error Display -->
              @if (error()) {
                <mat-card appearance="outlined" class="error-card">
                  <mat-card-content class="error-content">
                    <mat-icon color="warn">error</mat-icon>
                    <span class="mat-body-medium">{{ error() }}</span>
                  </mat-card-content>
                </mat-card>
              }
            </mat-card-content>

            <mat-card-actions align="end">
              <button
                mat-button
                type="button"
                (click)="resetForm()"
                [disabled]="saving()">
                <mat-icon>clear</mat-icon>
                Reset Form
              </button>
              <button
                mat-raised-button
                color="primary"
                type="submit"
                [disabled]="propertyForm.invalid || saving()"
                class="submit-button">
                <ng-container>
                @if (saving()) {
                  <mat-progress-spinner diameter="18"></mat-progress-spinner>
                  <span>{{ isEditMode() ? 'Updating...' : 'Creating...' }}</span>
                } @else {
                  <mat-icon>{{ isEditMode() ? 'save' : 'add' }}</mat-icon>
                  <span>{{ isEditMode() ? 'Update Property' : 'Create Property' }}</span>
                }</ng-container>
              </button>
            </mat-card-actions>
          </form>
        </mat-card>

        <!-- Property Tips -->
        <mat-card appearance="outlined" class="tips-card mat-elevation-1">
          <mat-card-header>
            <div mat-card-avatar class="tips-avatar">
              <mat-icon>lightbulb</mat-icon>
            </div>
            <mat-card-title class="mat-headline-small">
              {{ isEditMode() ? 'Editing Tips' : 'Property Creation Tips' }}
            </mat-card-title>
            <mat-card-subtitle class="mat-body-medium">
              {{ isEditMode() ? 'Best practices for updating properties' : 'Best practices for creating properties' }}
            </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="tips-list">
              <div class="tip-item">
                <mat-icon color="primary">check_circle</mat-icon>
                <span class="mat-body-medium">Use a descriptive and engaging title</span>
              </div>
              <div class="tip-item">
                <mat-icon color="primary">check_circle</mat-icon>
                <span class="mat-body-medium">Provide detailed information about the property</span>
              </div>
              <div class="tip-item">
                <mat-icon color="primary">check_circle</mat-icon>
                <span class="mat-body-medium">Set a competitive and realistic price</span>
              </div>
              <div class="tip-item">
                <mat-icon color="primary">check_circle</mat-icon>
                <span class="mat-body-medium">
                  {{ isEditMode() ? 'Review all attribute values for accuracy' : 'Fill in relevant attributes to help buyers' }}
                </span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    }
  </div>
</div>
